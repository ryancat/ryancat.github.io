!function(t){var e={};function i(o){if(e[o])return e[o].exports;var n=e[o]={i:o,l:!1,exports:{}};return t[o].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,o){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(o,n,function(e){return t[e]}.bind(null,n));return o},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);var o={};i.r(o),i.d(o,"EmptySprite",function(){return E}),i.d(o,"GroundSprite",function(){return _}),i.d(o,"WallSprite",function(){return P}),i.d(o,"CastleDoorSprite",function(){return T}),i.d(o,"TopDoorSprite",function(){return I}),i.d(o,"BottomDoorSprite",function(){return H}),i.d(o,"LeftDoorSprite",function(){return W}),i.d(o,"RightDoorSprite",function(){return N}),i.d(o,"WallTopSprite",function(){return R}),i.d(o,"BackgroundSprite",function(){return B}),i.d(o,"KingSprite",function(){return F}),i.d(o,"PlayerSprite",function(){return A}),i.d(o,"JohnSprite",function(){return K}),i.d(o,"KingDialogSprite",function(){return G}),i.d(o,"PlayerDialogSprite",function(){return Y}),i.d(o,"NpcJohnDialogSprite",function(){return z});var n={};function r(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}i.r(n),i.d(n,"john",function(){return re});var a=500,l=500,s=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=e.width,o=void 0===i?a:i,n=e.height,r=void 0===n?l:n,s=e.container,h=void 0===s?document.createElement("div"):s,c=e.key,u=void 0===c?"canvasLayer":c,f=e.game;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.container=h,this.key=u,this.game=f,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvas.style.position="absolute",this._canvas.setAttribute("data-key",this.key),this.container.appendChild(this._canvas),this.setSize(o,r)}var e,i,o;return e=t,(i=[{key:"setSize",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:150;this._canvas.offsetWidth===t&&this._canvas.offsetHeight===e||(this._canvas.style.offsetWidth=t+"px",this._canvas.style.offsetHeight=e+"px"),this._canvas.width=t,this._canvas.height=e}},{key:"drawRect",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.x,i=void 0===e?0:e,o=t.y,n=void 0===o?0:o,r=t.width,a=void 0===r?this._canvas.width:r,l=t.height,s=void 0===l?this._canvas.height:l,h=t.shouldFill,c=void 0===h||h,u=t.shouldStroke,f=void 0!==u&&u,d=t.backgroundColor,p=void 0===d?"red":d,y=t.borderColor,g=void 0===y?"black":y,v=t.opacity,m=void 0===v?1:v,b=this._ctx;b.save(),b.globalAlpha=m,b.fillStyle=p,b.strokeStyle=g,b.beginPath(),b.rect(i,n,a,s),c&&b.fill(),f&&b.stroke(),b.restore()}},{key:"drawText",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.x,i=void 0===e?0:e,o=t.y,n=void 0===o?0:o,r=t.align,a=void 0===r?"left":r,l=t.baseline,s=void 0===l?"alphabetic":l,h=t.text,c=void 0===h?"PLACE_HOLDER":h,u=t.fontSize,f=void 0===u?"16":u,d=t.color,p=void 0===d?"red":d,y=this._ctx;y.save(),y.font="".concat(f,"px serif"),y.fillStyle=p,y.textAlign=a,y.textBaseline=s,y.fillText(c,i,n),y.restore()}},{key:"clearRect",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.x,i=void 0===e?0:e,o=t.y,n=void 0===o?0:o,r=t.width,a=void 0===r?this._canvas.width:r,l=t.height,s=void 0===l?this._canvas.height:l;this._ctx.clearRect(i,n,a,s)}}])&&r(e.prototype,i),o&&r(e,o),t}();function h(t,e){var i=t.hitArea,o=e.hitArea,n=e.y+o.localY<=t.y+i.localY&&e.y+o.localY+o.localHeight>=t.y+i.localY&&e.y+o.localY+o.localHeight-(t.y+i.localY),r=t.x+i.localX<=e.x+o.localX&&t.x+i.localX+i.localWidth>=e.x+o.localX&&t.x+i.localX+i.localWidth-(e.x+o.localX),a=t.y+i.localY<=e.y+o.localY&&t.y+i.localY+i.localHeight>=e.y+o.localY&&t.y+i.localY+i.localHeight-(e.y+o.localY),l=e.x+o.localX<=t.x+i.localX&&e.x+o.localX+o.localWidth>=t.x+i.localX&&e.x+o.localX+o.localWidth-(t.x+i.localX),s=Math.max(r,l)&&+n,h=Math.max(a,n)&&+r,c=Math.max(r,l)&&+a,u=Math.max(a,n)&&+l;return{top:s,right:h,bottom:c,left:u,isHit:s||h||c||u}}function c(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var u=50,f=50,d=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),Object.assign(this,{x:0,y:0,width:u,height:f,offsetX:0,offsetY:0,backgroundColor:"red",name:"",hitArea:{},type:"sprite",disableHit:!1,hitType:"pass",scene:null,state:{}},e),this.initAggregateHitMap()}var e,i,o;return e=t,(i=[{key:"initAggregateHitMap",value:function(){this.aggregateHitMap={right:[],left:[],top:[],bottom:[]}}},{key:"getHitMoveCallback",value:function(t){var e;switch(t){case"pass":e=this.hitMovePass.bind(this);break;case"stop":e=this.hitMoveStop.bind(this);break;default:throw new Error("invalid hit type: ".concat(t))}return e}},{key:"hitSprite",value:function(t){if(t!==this&&!t.disableHit){var e=function(t,e){return e.children,h(t,e)}(this,t);e.isHit&&(e.right&&("pass"===t.hitType||this.vx>0)&&this.aggregateHitMap.right.push({sprite:t,value:e.right,direction:"right"}),e.left&&("pass"===t.hitType||this.vx<0)&&this.aggregateHitMap.left.push({sprite:t,value:e.left,direction:"left"}),e.top&&("pass"===t.hitType||this.vy<0)&&this.aggregateHitMap.top.push({sprite:t,value:e.top,direction:"top"}),e.bottom&&("pass"===t.hitType||this.vy>0)&&this.aggregateHitMap.bottom.push({sprite:t,value:e.bottom,direction:"bottom"}))}}},{key:"hitSprites",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.initAggregateHitMap(),e.forEach(this.hitSprite.bind(this));var i=Object.keys(this.aggregateHitMap).sort(function(e,i){return t.aggregateHitMap[i].length-t.aggregateHitMap[e].length})[0],o=this.aggregateHitMap[i].sort(function(t,e){return e.value-t.value})[0];if(o){localStorage.getItem("GAME_DEBUG_MODE")&&console.log(o);var n=o.sprite;this.getHitMoveCallback(n.hitType)(o),n.hitCallback(this),n.scene&&n.scene.hitCallback(this)}}},{key:"hitMoveStop",value:function(t){var e=t.value,i=void 0===e?0:e,o=t.direction,n=void 0===o?"":o;switch(n){case"top":this.y+=i,this.vy=0;break;case"bottom":this.y-=i,this.vy=0;break;case"left":this.x+=i,this.vx=0;break;case"right":this.x-=i,this.vx=0;break;default:throw new Error("unexpected hit direction: ".concat(n))}}},{key:"hitMovePass",value:function(){}},{key:"move",value:function(){this.game.flag.disableMove||"tileSprite"!==this.type&&(this.x+=this.vx,this.checkHitSprites(),this.y+=this.vy,this.checkHitSprites())}},{key:"checkHitSprites",value:function(){this.hitSprites(this.getPossibleHitSprites())}},{key:"getPossibleHitSprites",value:function(){for(var t=this,e=this.map.colNum/this.map.width,i=this.map.rowNum/this.map.height,o=this.hitArea,n=Math.floor((this.x+o.localX)*e),r=Math.floor((this.x+o.localX+o.localWidth)*e),a=Math.floor((this.y+o.localY)*i),l=Math.floor((this.y+o.localY+o.localHeight)*i),s=[],h=a;h<=l;h++)for(var c=n;c<=r;c++)s.push(h*this.map.colNum+c);var u=[];return s.forEach(function(e){t.map.children.forEach(function(i){"objects"===i.name?u=u.concat(i.children.filter(function(e){return e!==t})):["obstacles","items"].indexOf(i.name)>=0&&i.children[e]&&"empty"!==i.children[e].name&&u.push(i.children[e])})}),u}},{key:"hitCallback",value:function(t){}},{key:"update",value:function(t){}},{key:"render",value:function(t,e){}}])&&c(e.prototype,i),o&&c(e,o),t}();function p(t){return(p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function y(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function g(t,e){return!e||"object"!==p(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function v(t){return(v=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function m(t,e){return(m=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var b=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(t=g(this,v(e).call(this,Object.assign({tileIndex:-1,colIndex:-1,rowIndex:-1},i)))).setHitArea(),t}var i,o,n;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&m(t,e)}(e,d),i=e,(o=[{key:"setHitArea",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.localX,i=void 0===e?0:e,o=t.localY,n=void 0===o?0:o,r=t.localWidth,a=void 0===r?this.width:r,l=t.localHeight,s=void 0===l?this.height:l;Object.assign(this.hitArea,{localX:i,localY:n,localWidth:a,localHeight:s})}},{key:"update",value:function(t){}},{key:"render",value:function(t,e){var i=e.game.camera,o=this.x-i.x,n=this.y-i.y;o<-this.width||o>i.width||n<-this.height||n>i.height||(e.drawRect({x:o,y:n,width:this.width,height:this.height,shouldFill:!0,shouldStroke:!1,backgroundColor:this.backgroundColor}),this.showName&&e.drawText({text:this.name,x:o+this.width/2,y:n,baseline:"bottom",align:"center",width:this.width,height:this.height,shouldFill:!0,shouldStroke:!1,color:this.backgroundColor}),localStorage.getItem("GAME_DEBUG_MODE")&&e.drawRect({x:o+this.hitArea.localX,y:n+this.hitArea.localY,width:this.hitArea.localWidth,height:this.hitArea.localHeight,shouldFill:!1,shouldStroke:!0,borderColor:"red"}))}}])&&y(i.prototype,o),n&&y(i,n),e}(),w={red:["#F5BEBE","#E86767","#DB1111","#8C0B0B","#3C0505"],blue:["#D1EDF5","#AFDFEE","#82CEE5","#538492","#24393F"],green:["#D7EBD3","#B9DCB2","#91C987","#5DB056","#283725"],brown:["#DAC1AD","#B6845C","#8D501D","#553011","#2B1809"],gunmetal:["#C3C8C9","#738082","#374A4D","#1D2E32","#0D1516"]};function k(t){return(k="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function S(t){return(S=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function x(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function O(t,e){return(O=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var C=w.brown[2],D=w.blue[2],M=w.green[1];function j(t){var e=t.backgroundColor,i=void 0===e?w.red[3]:e,o=t.opacity,n=void 0===o?1:o,r=t.name,a=void 0===r?"placeholder":r,l=t.hitType,s=void 0===l?"pass":l,h=t.showName,c=void 0!==h&&h,u=t.render,f=t.callback,d=void 0===f?function(){}:f;return function(t){function e(){var t,o,r,l=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),o=this,t=!(r=S(e).call(this,Object.assign({opacity:n,backgroundColor:i,name:a,hitType:s,showName:c},l)))||"object"!==k(r)&&"function"!=typeof r?x(o):r,u&&(t.render=u),d.call(x(t)),t}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&O(t,e)}(e,b),e}()}var E=j({opacity:0,name:"empty",render:function(){}}),_=j({name:"ground",backgroundColor:w.gunmetal[3]}),P=j({name:"wall",backgroundColor:w.brown[3],hitType:"stop"}),T=j({name:"castleDoorSprite",backgroundColor:w.green[3]}),I=j({name:"topDoorSprite",backgroundColor:w.green[3]}),H=j({name:"bottomDoorSprite",backgroundColor:w.green[3]}),W=j({name:"leftDoorSprite",backgroundColor:w.green[3]}),N=j({name:"rightDoorSprite",backgroundColor:w.green[3]}),R=j({name:"wallTopSprite",backgroundColor:w.brown[1]}),B=j({name:"backgroundSprite",backgroundColor:w.gunmetal[4],opacity:0}),F=j({name:"king",backgroundColor:D,hitType:"stop",showName:!0}),A=j({name:"player",backgroundColor:C,showName:!0,callback:function(){this.vx=0,this.vy=0,this.vMax=this.width/4,this.setHitArea({localX:0,localY:this.height/2,localWidth:this.width,localHeight:this.height/2})}}),K=j({name:"john",backgroundColor:M,hitType:"stop",showName:!0}),G=j({name:"kingDialogSprite",backgroundColor:D}),Y=j({name:"playerDialogSprite",backgroundColor:C}),z=j({name:"npcJohnDialogSprite",backgroundColor:M});function L(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var X=32,J=32,U=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),Object.assign(this,{colIndex:0,rowIndex:0,colNum:X,rowNum:J,children:[],parent:null,type:"group"},e)}var e,i,o;return e=t,(i=[{key:"add",value:function(t){this.children.push(t),t.parent=this}},{key:"clear",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.renderer;e.clearRect()}},{key:"render",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.renderer;this.children.forEach(function(i){return i.render(t,e)})}},{key:"update",value:function(t){this.children.forEach(function(e){return e.update(t)})}},{key:"getSpriteByName",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return this.getSprite("name",t)}},{key:"getSpritesByName",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return this.getSprites("name",t)}},{key:"getSprite",value:function(e,i){for(var o,n=0;n<this.children.length;n++){var r=this.children[n];if(r instanceof t?o=r.getSprite(e,i):r[e]===i&&(o=r),o)return o}return null}},{key:"getSprites",value:function(e,i){for(var o=[],n=0;n<this.children.length;n++){var r=this.children[n];r instanceof t?o=o.concat(r.getSprites(e,i)):r[e]===i&&o.push(r)}return o}},{key:"renderer",get:function(){for(var t=this._renderer;!t&&this.parent;)t=this.parent.renderer;return t},set:function(t){this._renderer=t}}])&&L(e.prototype,i),o&&L(e,o),t}();function q(t){return(q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function Q(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function V(t,e){return!e||"object"!==q(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function Z(t){return(Z=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function $(t,e){return($=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var tt=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),V(this,Z(e).call(this,Object.assign({children:[],width:0,height:0},t)))}var i,o,n;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&$(t,e)}(e,d),i=e,(o=[{key:"addSprites",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];e.forEach(function(e){return t.addSprite(e)})}},{key:"addSprite",value:function(t){if(-1===this.children.indexOf(t)){if(0===this.children.length)this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,t.offsetX=0,t.offsetY=0;else{var e=Math.max(0,this.x-t.x),i=Math.max(0,this.y-t.y);e&&(this.children.forEach(function(t){t.offsetX+=e}),this.x=Math.min(this.x,t.x)),i&&(this.children.forEach(function(t){t.offsetY+=i}),this.y=Math.min(this.y,t.y)),this.width=Math.max(this.width,t.x+t.width-this.x),this.height=Math.max(this.height,t.y+t.height-this.y),t.offsetX=t.x-this.x,t.offsetY=t.y-this.y}this.children.push(t),t.scene=this}}},{key:"removeSprite",value:function(t){var e=this.children.indexOf(t);if(-1!==e){if(this.children.splice(e,1),t.scene=null,0===this.children.length)this.x=0,this.y=0,this.width=0,this.height=0;else{if(this.width=Math.min(this.width,t.x+t.width-this.x),this.height=Math.min(this.height,t.y+t.height-this.y),t.x===this.x){var i=this.children.reduce(function(t,e){return Math.min(t.x,e.x)}),o=i-t.x;this.children.forEach(function(t){return t.offsetX+=o}),this.x=i}if(t.y===this.y){var n=this.children.reduce(function(t,e){return Math.min(t.y,e.y)}),r=n-t.y;this.children.forEach(function(t){return t.offsetY+=r}),this.y=n}}t.offsetX=0,t.offsetY=0}}},{key:"setHitArea",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.localX,i=void 0===e?0:e,o=t.localY,n=void 0===o?0:o,r=t.localWidth,a=void 0===r?this.width:r,l=t.localHeight,s=void 0===l?this.height:l;this.children.filter(function(t){return t.offsetX<i||t.offsetX+t.width>a||t.offsetY<n||t.offsetY+t.height>s}).forEach(function(t){return t.disableHit=!0})}},{key:"render",value:function(t,e){this.children.forEach(function(i){return i.render(t,e)})}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this.children&&this.children.forEach(function(e){e.y=t+e.offsetY})}},{key:"x",get:function(){return this._x},set:function(t){this._x=t,this.children&&this.children.forEach(function(e){e.x=t+e.offsetX})}},{key:"hitType",get:function(){return this._hitType},set:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"pass";this._hitType=t,this.children&&this.children.forEach(function(e){e.hitType=t})}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"red";this._backgroundColor=t,this.children&&this.children.forEach(function(e){e.backgroundColor=t})}}])&&Q(i.prototype,o),n&&Q(i,n),e}();function et(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var it=32,ot=32,nt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),Object.assign(this,{key:"BaseIncident",flag:{finished:!1,initState:!1,bindEventCallback:!1,addSceneSprites:!1,setCamera:!1,setPlayerStatus:!1,renderBackground:!1,layerDirtyArr:[],layerClearDirtyArr:[]},sceneSprites:[],rowNum:it,colNum:ot,playerStatus:{},incidentStatus:{}},e)}var e,i,o;return e=t,(i=[{key:"play",value:function(t){var e=this;return!(!this.flag.finished&&(this.flag.setIncidentStatus?this.flag.initState?this.flag.renderBackground?this.flag.setPlayerStatus?this.flag.setCamera?this.flag.addSceneSprites?this.flag.bindEventCallback?(this.update(t),this.flag.layerClearDirtyArr.forEach(function(i,o){i&&e.mapGroup.children[o].clear(t)}),this.flag.layerDirtyArr.forEach(function(i,o){i&&e.mapGroup.children[o].render(t)}),1):(this.bindEventCallback(),this.flag.bindEventCallback=!0,1):(this.addSceneSprites(),this.flag.addSceneSprites=!0,1):(this.setCamera(),this.flag.setCamera=!0,1):(this.setPlayerStatus(),this.flag.setPlayerStatus=!0,1):(this.renderBackground(),this.flag.renderBackground=!0,1):(this.initMapGroup(),this.flag.initState=!0,1):(this.setIncidentStatus(),this.flag.setIncidentStatus=!0,1)))}},{key:"finish",value:function(){this.flag.finished=!0}},{key:"restart",value:function(){this.flag.finished=!1,this.flag.setCamera=!1,this.flag.setPlayerStatus=!1}},{key:"createMapData",value:function(){}},{key:"initMapGroup",value:function(){var t=this;this.createMapData(),this.mapGroup=new U({colNum:this.mapData.width,rowNum:this.mapData.height,width:this.width,height:this.height,tileSpriteMap:this.mapData.tileSpriteMap,objectSpriteMap:this.mapData.objectSpriteMap,layers:this.mapData.layers,renderer:this.game.layerMap.main,type:"map"}),this.mapGroup.layers.forEach(function(e){var i=new U({colNum:t.mapGroup.colNum,rowNum:t.mapGroup.rowNum,width:t.mapGroup.width,height:t.mapGroup.height,type:"layer",name:e.name,renderer:t.mapGroup.renderer,map:t.mapGroup}),o=i.width/i.colNum,n=i.height/i.rowNum;switch(e.type){case"tilelayer":e.data.forEach(function(e,r){var a=r%i.colNum,l=Math.floor(r/i.colNum);i.add(t.game.createTileSprite(t.mapGroup.tileSpriteMap[e],{x:a*o,y:l*n,width:o,height:n,colIndex:a,rowIndex:l,tileIndex:r,layer:i,map:t.mapGroup,game:t.game}))});break;case"objectgroup":e.objects.forEach(function(e){i.add(t.game.createObjectSprite(t.mapGroup.objectSpriteMap[e.id],{x:e.x,y:e.y,width:e.width,height:e.height,name:e.name,layer:i,map:t.mapGroup,game:t.game}))})}t.mapGroup.add(i)}),this.flag.layerDirtyArr=this.mapGroup.layers.map(function(){return!0}),this.flag.layerClearDirtyArr=this.mapGroup.layers.map(function(){return!0})}},{key:"getSceneByName",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return this.sceneSprites.filter(function(e){return e.name===t})[0]}},{key:"addSceneBySpriteName",value:function(t,e){var i=this.mapGroup.getSpritesByName(e),o=new tt;return o.addSprites(i),o.name=t,this.sceneSprites.push(o),o}},{key:"setPlayerStatus",value:function(){}},{key:"setIncidentStatus",value:function(){this.width=this.colNum*this.game.tileWidth,this.height=this.rowNum*this.game.tileHeight}},{key:"renderBackground",value:function(){this.game.layerMap.background.drawRect({backgroundColor:w.gunmetal[4]})}},{key:"update",value:function(t){}},{key:"addSceneSprites",value:function(){}},{key:"setCamera",value:function(){}},{key:"bindEventCallback",value:function(){}}])&&et(e.prototype,i),o&&et(e,o),t}();function rt(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var at=60,lt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),Object.assign(this,{fps:at,callbacks:[],isPaused:!0,timeoutId:null},e),this.run(),this.lastRun=Date.now()}var e,i,o;return e=t,(i=[{key:"add",value:function(){for(var t=this,e=arguments.length,i=new Array(e),o=0;o<e;o++)i[o]=arguments[o];i.forEach(function(e){-1===t.callbacks.indexOf(e)&&t.callbacks.push(e)})}},{key:"remove",value:function(t){var e=this.callbacks.indexOf(t);e>=0&&this.callbacks.splice(e,1)}},{key:"removeAll",value:function(){this.callbacks=[]}},{key:"run",value:function(){this.timeoutId=window.requestAnimationFrame(this.run.bind(this));var t=Date.now(),e=this.lastRun;if(this.lastRun=t,!this.isPaused){var i=t-e;i>=1e3/this.fps&&this.callbacks.forEach(function(t){return t(i)})}}},{key:"start",value:function(){this.isPaused=!1}},{key:"stop",value:function(){this.isPaused=!0,this.lastRun=null}},{key:"destroy",value:function(){this.callbacks=[],window.cancelAnimationFrame(this.timeoutId)}}])&&rt(e.prototype,i),o&&rt(e,o),t}(),st=document.createElement("canvas").getContext("2d");function ht(t,e,i){var o,n,r,a,l,s=0;if(""===t||"string"!=typeof t)return"";if(e=e||1/0,(i=i||{}).fromDirection=i.fromDirection||"left",i.fontFamily=i.fontFamily||Theme.fontFamily,i.fontSize=i.fontSize||Theme.labelFontSize,i.fontStyle=i.fontStyle||"normal",i.fontWeight=i.fontWeight||"normal",ct(t,i.fontFamily,i.fontSize,i.fontStyle,i.fontWeight)<=e)return t;for(o=(r=t.split(" ")).length;s<=o;)if(n=Math.floor((s+o)/2),(l=ct(a="right"===i.fromDirection?r.slice(n).join(" "):r.slice(0,n).join(" "),i.fontFamily,i.fontSize,i.fontStyle,i.fontWeight))<e)if("right"===i.fromDirection){if(o===n)break;o=n}else{if(s===n)break;s=n}else{if(!(l>e)){"right"===i.fromDirection?o=n:s=n;break}if("right"===i.fromDirection){if(s===n)break;s=n}else{if(o===n)break;o=n}}return a}function ct(t,e,i,o,n){return o||(o="normal"),n||(n="normal"),st.font=o+" "+n+" "+i+"px "+e,st.measureText(t,e,i).width}function ut(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var ft=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],i=arguments.length>1?arguments[1]:void 0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"foreground";!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t);i.camera;Object.assign(this,{contentObjs:e,game:i,layerKey:o,loop:new lt,endCallbacks:[],renderer:i.layerMap[o],enterKey:i.keyMap.enter,enterKeyActive:!1,activeContentIndex:0}),this.loop.add(this.update.bind(this)),this.loop.start()}var e,i,o;return e=t,(i=[{key:"start",value:function(){this.game.pauseMove()}},{key:"update",value:function(t){var e=this,i=this.contentObjs[this.activeContentIndex];"string"==typeof i&&(i={fromSpriteKey:"",content:i,contentCallback:function(){},options:{}});var o=i,n=o.fromSpriteKey,r=void 0===n?"":n,a=o.content,l=void 0===a?"":a,s=o.contentCallback,h=void 0===s?function(){}:s,c=o.options,u=void 0===c?{}:c;this.clear();var f=this.game.camera;this.renderer.drawRect({x:0,y:.8*f.height,width:f.width,height:f.height-Math.floor(.8*f.height),opacity:.95,shouldFill:!0,shouldStroke:!1,backgroundColor:w.blue[3]}),new this.game.spriteClassMap[r]({x:f.x,y:f.y+.8*f.height,width:Math.floor(.2*f.width),height:f.height-Math.floor(.8*f.height)}).render(t,this.renderer),function(t,e){var i,o,n=[],r=0;if("string"!=typeof t)return[t];if(""===t)return[""];for((e=e||{}).maxLineNum=e.maxLineNum>0?e.maxLineNum:1,e.exceedingLine=e.exceedingLine||"last",e.fontFamily=e.fontFamily||"Roboto",e.fontSize=e.fontSize||"20",e.fontStyle=e.fontStyle||"normal",e.fontWeight=e.fontWeight||"normal",e.maxWrappedWidth=e.maxWrappedWidth>=0?e.maxWrappedWidth:1/0,e.maxWrappedHeight=e.maxWrappedHeight>=0?Math.max(e.maxWrappedHeight,e.fontSize):1/0,o=Math.min(e.maxLineNum,Math.floor(e.maxWrappedHeight/e.fontSize));r<o&&t.length>0;){if("first"===e.exceedingLine){if(r===o-1){n.unshift(t);break}(i=ht(t,e.maxWrappedWidth,{fromDirection:"right",fontFamily:e.fontFamily,fontSize:e.fontSize,fontStyle:e.fontStyle,fontWeight:e.fontWeight})).length>0&&(n.unshift(i),t=t.slice(0,t.length-i.length).trim())}else{if(r===o-1){n.push(t);break}(i=ht(t,e.maxWrappedWidth,{fromDirection:"left",fontFamily:e.fontFamily,fontSize:e.fontSize,fontStyle:e.fontStyle,fontWeight:e.fontWeight})).length>0&&(n.push(i),t=t.slice(i.length).trim())}r++}return n}(l,{maxWrappedWidth:f.width-Math.floor(f.width*(.2+.1)),maxWrappedHeight:f.height-Math.floor(.9*f.height),maxLineNum:1/0,fontSize:20}).forEach(function(t,i){e.renderer.drawText({x:Math.floor(.25*f.width),y:Math.floor(f.height*(.8+.05))+20*i,text:t,align:"start",color:u.color||w.gunmetal[4],fontSize:20})}),this.enterKey.isDown&&(this.enterKeyActive=!0),!this.enterKey.isDown&&this.enterKeyActive&&(this.enterKeyActive=!1,this.activeContentIndex++,h(),this.activeContentIndex>=this.contentObjs.length&&this.end())}},{key:"clear",value:function(){this.renderer.clearRect({x:this.x,y:this.y,width:this.width,height:this.height})}},{key:"end",value:function(){this.loop.destroy(),this.clear(),this.endCallbacks.forEach(function(t){return t()}),this.game.resumeMove()}}])&&ut(e.prototype,i),o&&ut(e,o),t}();function dt(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var pt=640,yt=640,gt=function(){function t(e){var i=e.game,o=e.x,n=void 0===o?0:o,r=e.y,a=void 0===r?0:r,l=e.width,s=void 0===l?pt:l,h=e.height,c=void 0===h?yt:h;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),Object.assign(this,{game:i,x:n,y:a,width:s,height:c,followingSprite:null,followingCallback:null})}var e,i,o;return e=t,(i=[{key:"follow",value:function(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1],this.followingSprite=t,this.followingCallback&&this.game.loop.remove(this.followingCallback),this.followingCallback=this.updateCameraByFollow.bind(this),this.game.loop.add(this.followingCallback),this.updateCameraByFollow()}},{key:"updateCameraByFollow",value:function(){var t=(this.width-this.followingSprite.width)/2,e=(this.height-this.followingSprite.height)/2;this.x=this.followingSprite.x-t,this.y=this.followingSprite.y-e}}])&&dt(e.prototype,i),o&&dt(e,o),t}();function vt(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,o)}return i}function mt(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?vt(i,!0).forEach(function(e){bt(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):vt(i).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function bt(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function wt(t,e){if(null==t)return{};var i,o,n=function(t,e){if(null==t)return{};var i,o,n={},r=Object.keys(t);for(o=0;o<r.length;o++)i=r[o],e.indexOf(i)>=0||(n[i]=t[i]);return n}(t,e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);for(o=0;o<r.length;o++)i=r[o],e.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(t,i)&&(n[i]=t[i])}return n}function kt(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var St=20,xt=20,Ot="fit",Ct="#000",Dt=60,Mt=(new s,function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),Object.assign(this,{tileWidth:St,tileHeight:xt,scaleMode:Ot,backgroundColor:Ct,fps:Dt,flag:{},container:document.createElement("div"),incidentPlays:[],incidentMap:{},sprites:[],layerMap:{},keyMap:{}},e),this.loop=new lt({fps:this.fps}),this.camera=new gt({game:this,width:e.cameraWidth,height:e.cameraHeight,x:e.cameraX,y:e.cameraY})}var e,i,n;return e=t,n=[{key:"createKeyInteraction",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e={keyCodes:t,pressStartTime:null,pressDuration:0,isDown:!1};return document.addEventListener("keydown",function(t){if(-1!==e.keyCodes.indexOf(t.keyCode)){e.isDown=!0;var i=Date.now();e.pressStartTime?e.pressDuration=i-e.pressStartTime:e.pressStartTime=i,t.preventDefault()}}),document.addEventListener("keyup",function(t){-1!==e.keyCodes.indexOf(t.keyCode)&&(e.isDown=!1,e.pressStartTime=null,e.pressDuration=0,t.preventDefault())}),e}}],(i=[{key:"loadSprites",value:function(){this.spriteClassMap=o}},{key:"loadSounds",value:function(){}},{key:"addInteractionKey",value:function(t,e){this.keyMap[t]=e}},{key:"addLayer",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"layer",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=e.width,o=void 0===i?this.camera.width:i,n=e.height,r=void 0===n?this.camera.height:n,a=e.renderer,l=void 0===a?new s({width:o,height:r,container:this.container,key:t,game:this}):a;this.layerMap[t]=l}},{key:"addIncident",value:function(t){var e=t.incidentClass,i=void 0===e?nt:e,o=t.isForced,n=void 0!==o&&o,r=t.key,a=void 0===r?"":r,l=t.playerStatus,s=void 0===l?{}:l,h=wt(t,["incidentClass","isForced","key","playerStatus"]),c=!n&&this.incidentMap[a]?this.incidentMap[a]:{timeStamps:[],incident:new i(mt({game:this,key:a,playerStatus:s},h))};c.timeStamps.push(Date.now()),this.incidentMap[a]=c;var u=c.incident;u.playerStatus=s,u.restart(),c.playIncident=c.playIncident||u.play.bind(u);var f=this.incidentPlays.indexOf(c.playIncident);f>=0&&this.incidentPlays.splice(f,1),this.incidentPlays.push(c.playIncident)}},{key:"createTileSprite",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=Object.assign({type:"tileSprite"},e);return new this.spriteClassMap[t](i)}},{key:"createObjectSprite",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=Object.assign({type:"objectSprite"},e);return new this.spriteClassMap[t](i)}},{key:"playConversation",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};this.dialog=new ft(e,this),this.dialog.start(),this.dialog.endCallbacks.push(i,function(){delete t.dialog}.bind(this))}},{key:"pause",value:function(){this.loop.stop()}},{key:"resume",value:function(){this.loop.start()}},{key:"pauseMove",value:function(){this.flag.disableMove=!0}},{key:"resumeMove",value:function(){this.flag.disableMove=!1}}])&&kt(e.prototype,i),n&&kt(e,n),t}());function jt(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var Et=new(function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._seed=e%2147483647,this._seed<=0&&(this._seed+=2147483646)}var e,i,o;return e=t,(i=[{key:"next",value:function(){return this._seed=16807*this._seed%2147483647}},{key:"nextFloat",value:function(){return(this.next()-1)/2147483646}}])&&jt(e.prototype,i),o&&jt(e,o),t}())(1234567),_t=32,Pt=32,Tt=16,It=16,Ht=12,Wt=0,Nt=1,Rt=2,Bt=3,Ft=4,At=5,Kt=6,Gt=7,Yt=8,zt={width:_t,height:Pt,x:0,y:0,data:[],id:-1,name:"ground",opacity:1,type:"tilelayer",visible:!0},Lt={draworder:"topdown",id:4,name:"objects",objects:[],opacity:1,type:"objectgroup",visible:!0,x:0,y:0},Xt={height:48,id:3,name:"player",rotation:0,visible:!0,width:32,x:240,y:224},Jt={layers:[],width:_t,height:Pt,tileheight:It,tilewidth:Tt,version:1.2,type:"map"},Ut=Math.ceil(100*Et.nextFloat()),qt=Math.ceil(100*Et.nextFloat()),Qt={};function Vt(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_t,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Pt,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=i.name,n=i.meta,r=[],a=(void 0===n?{}:n).doors||["bottom"],l=0;l<e;l++)for(var s=0;s<t;s++){var h=l*t+s;switch(o){case"background":r[h]=Nt;break;case"ground":r[h]=l>=2?Rt:0;break;case"obstacles":var c=-1===a.indexOf("top")?1===l||2===l:(1===l||2===l)&&(s<(t-Ht)/2||s>=(t+Ht)/2),u=-1===a.indexOf("bottom")?l===e-1||l===e-2:(l===e-1||l===e-2)&&(s<(t-Ht)/2||s>=(t+Ht)/2),f=-1===a.indexOf("left")?0===s&&l>=1:0===s&&l>=2&&(l<(e-Ht)/2||l>=(e+Ht)/2),d=-1===a.indexOf("right")?s===t-1&&l>=1:s===t-1&&l>=2&&(l<(e-Ht)/2||l>=(e+Ht)/2);r[h]=c||u||f||d?Bt:0;break;case"items":var p=2===l&&s>=(t-Ht)/2&&s<(t+Ht)/2,y=l===e-1&&s>=(t-Ht)/2&&s<(t+Ht)/2,g=0===s&&l>=(e-Ht)/2&&l<(e+Ht)/2,v=s===t-1&&l>=(e-Ht)/2&&l<(e+Ht)/2;a.indexOf("top")>=0&&p?r[h]=Ft:a.indexOf("bottom")>=0&&y?r[h]=Kt:a.indexOf("left")>=0&&g?r[h]=Gt:a.indexOf("right")>=0&&v?r[h]=At:r[h]=Wt;break;case"wallTop":var m=-1===a.indexOf("top")?0===l:0===l&&(s<(t-Ht)/2||s>=(t+Ht)/2),b=-1===a.indexOf("bottom")?l===e-3:l===e-3&&(s<(t-Ht)/2||s>=(t+Ht)/2),w=-1===a.indexOf("left")?0===s&&l>=0&&l<=e-3:0===s&&l>=1&&l<=e-3&&(l<(e-Ht)/2||l>=(e+Ht)/2),k=-1===a.indexOf("right")?s===t-1&&l>=0&&l<=e-3:s===t-1&&l>=1&&l<=e-3&&(l<(e-Ht)/2||l>=(e+Ht)/2);r[h]=m||b||w||k?Yt:0}}return r}function Zt(){var t=function(t){t.type;var e=t.x,i=void 0===e?0:e,o=t.y,n=void 0===o?0:o,r=t.width,a=void 0===r?64:r,l=t.height,s=void 0===l?64:l,h=t.doors,c=void 0===h?["bottom"]:h,u=t.doorColor,f=void 0===u?w.red[3]:u,d=t.groundColor,p=void 0===d?w.gunmetal[1]:d,y=t.wallColor,g=void 0===y?w.brown[3]:y,v=t.wallTopColor,m=void 0===v?w.brown[1]:v,b=t.backgroundColor,k=void 0===b?w.gunmetal[4]:b,S=t.tileWidth,x=void 0===S?Tt:S,O=t.tileHeight,C=void 0===O?It:O,D=t.objects,M=void 0===D?[]:D,j=[{name:"background",type:"tilelayer"},{name:"ground",type:"tilelayer"},{name:"obstacles",type:"tilelayer",meta:{doors:c}},{name:"items",type:"tilelayer",meta:{doors:c}},{name:"objects",type:"objectgroup"},{name:"wallTop",type:"tilelayer",meta:{doors:c}}].map(function(t){var e;switch(t.type){case"tilelayer":e=Object.assign({},zt,{data:Vt(a,s,t),width:a,height:s,x:i,y:n,id:Ut++,name:t.name,type:t.type});break;case"objectgroup":e=Object.assign({},Lt,{x:i,y:n,objects:M.map(function(t){var e=qt++;return Qt[t.name]=e,Object.assign({},Xt,t,{id:e})}),id:Ut++,name:t.name,type:t.type});break;default:throw new Error("invalid layer type: ".concat(t.type))}return e});return Object.assign({},Jt,{layers:j,width:a,height:s,tilewidth:x,tileheight:C,spriteMetaMap:{BACKGROUND_SPRITE:{backgroundColor:k},GROUND_SPRITE:{backgroundColor:p},WALL_SPRITE:{backgroundColor:g},TOP_DOOR_SPRITE:{backgroundColor:f},RIGHT_DOOR_SPRITE:{backgroundColor:f},BOTTOM_DOOR_SPRITE:{backgroundColor:f},LEFT_DOOR_SPRITE:{backgroundColor:f},WALL_TOP_SPRITE:{backgroundColor:m}}})}(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}),e={};for(var i in e[Wt]="EmptySprite",e[Nt]="BackgroundSprite",e[Rt]="GroundSprite",e[Ft]="TopDoorSprite",e[At]="RightDoorSprite",e[Kt]="BottomDoorSprite",e[Gt]="LeftDoorSprite",e[Bt]="WallSprite",e[Yt]="WallTopSprite",Object.assign(t,{tileSpriteMap:e,objectSpriteMap:{}}),Qt)t.objectSpriteMap[Qt[i]]=i.charAt(0).toUpperCase()+i.substring(1)+"Sprite";return t}function $t(t){return($t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function te(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function ee(t,e){return!e||"object"!==$t(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function ie(t){return(ie=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function oe(t,e){return(oe=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var ne=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(t=ee(this,ie(e).call(this,i))).objectWidth={xs:t.game.tileWidth/2,s:t.game.tileWidth,m:2*t.game.tileWidth,l:3*t.game.tileWidth,xl:4*t.game.tileWidth},t.objectHeight={xs:t.game.tileHeight/2,s:t.game.tileHeight,m:2*t.game.tileHeight,l:3*t.game.tileHeight,xl:4*t.game.tileHeight},t}var i,o,n;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&oe(t,e)}(e,nt),i=e,n=[{key:"hashDoor",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=["top","right","bottom","left"];return(t="0000".substring(t.length)+t).split("").map(function(t,i){return"1"===t?e[i]:""})}},{key:"getOppositeDoor",value:function(t){switch(t){case"top":return"bottom";case"right":return"left";case"bottom":return"top";case"left":return"right";default:throw new Error("invalid door: ".concat(t))}}}],(o=[{key:"setPlayerStatus",value:function(){var t=this.mapGroup.getSpriteByName("player");if(this.playerStatus.fromDoor)switch(this.playerStatus.fromDoor){case"top":t.x=(this.width-t.width)/2,t.y=3*this.game.tileHeight;break;case"bottom":t.x=(this.width-t.width)/2,t.y=this.height-this.game.tileHeight-t.height;break;case"left":t.x=this.game.tileWidth,t.y=(this.height-t.height)/2;break;case"right":t.x=this.width-this.game.tileWidth-t.width,t.y=(this.height-t.height)/2;break;default:throw new Error("invalide from door direction: ".concat(this.playerStatus.fromDoor))}}}])&&te(i.prototype,o),n&&te(i,n),e}();function re(t,e,i){if(i.cellRow===i.game.maze.startRow&&i.cellCol===i.game.maze.startCol)return t.state.hasIntroduced?[{fromSpriteKey:"NpcJohnDialogSprite",content:"I heard the gem of fire is in the south",options:{color:w.red[3]}}]:(t.state.hasIntroduced=!0,[{content:"Yes?"},{fromSpriteKey:"PlayerDialogSprite",content:"I..."},{content:"Let me guess! You are looking for the gem of light?"},{fromSpriteKey:"PlayerDialogSprite",content:"Actually..."},{content:"Wait! Is it gem of ice?"},{fromSpriteKey:"PlayerDialogSprite",content:"(Sigh) Nope"},{content:"Oh, it must be gem of fire then! You have a long way to go, my friend!"},{fromSpriteKey:"PlayerDialogSprite",content:"Why do you say that?"},{content:"Well... You are not the first warrior come here. Definitely not the last one."},{content:"The land of three gems is not what it used to be. The dragons have taken all the three gems!"},{content:"They say the gem of fire will give you strenth..."},{content:"the gem of ice will give you dexterity..."},{content:"and the gem of light will give you wisdom!"},{content:"Each gem is protected by a powerful dragon, and they are stronger than all other monsters out there!"},{content:"Remember! You cannot pass the doors unless all the monsters are cleard in that room!"},{content:"I have cleared this room for you. You are welcome! Now the doors are opened!",contentCallback:function(){i.doorScenes.forEach(function(t){t.backgroundColor=w.green[3],t.hitType="pass"})}},{content:"Good luck, my friend! You need to find your way across the maze. I heard the gem of fire is in the south",options:{color:w.red[3]}}].map(function(t){return t.fromSpriteKey||(t.fromSpriteKey="NpcJohnDialogSprite"),t}))}function ae(t){return(ae="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function le(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function se(t,e){return!e||"object"!==ae(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function he(t){return(he=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function ce(t,e){return(ce=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var ue=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(t=se(this,he(e).call(this,i))).cellRow=parseInt(t.key.split("@")[1]),t.cellCol=parseInt(t.key.split("@")[2]),t}var i,o,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&ce(t,e)}(e,ne),i=e,(o=[{key:"createMapData",value:function(){this.doors=ne.hashDoor(this.game.maze.cells[this.cellRow][this.cellCol]),this.mapData=Zt({doors:this.doors.filter(function(t){return""!==t}),width:this.colNum,height:this.rowNum,tileWidth:this.game.tileWidth,tileHeight:this.game.tileHeight,objects:(this.incidentStatus.npcs||[]).concat([{x:(this.width-this.objectWidth.m)/2,y:(this.height-this.objectHeight.l)/2,width:this.objectWidth.m,height:this.objectHeight.l,name:"player"}])})}},{key:"update",value:function(t){var e=this.mapGroup.getSpriteByName("player");this.handlePlayerMove(e,t)}},{key:"addSceneSprites",value:function(){var t=this;this.doorScenes=this.doors.map(function(e){return""!==e?t.addSceneBySpriteName("".concat(e,"Door"),"".concat(e,"DoorSprite")):null}),this.cellRow===this.game.maze.startRow&&this.cellCol===this.game.maze.startCol&&(this.mapGroup.getSpriteByName("john").state.hasIntroduced||this.doorScenes.forEach(function(t){"topDoor"!==t.name&&(t.backgroundColor=w.red[3],t.hitType="stop")}))}},{key:"setCamera",value:function(){var t=this.mapGroup.getSpriteByName("player");this.game.camera.follow(t)}},{key:"bindEventCallback",value:function(){this.handleDoors(),this.handleNpcs()}},{key:"handleDoors",value:function(){var t=this;this.doorScenes.forEach(function(i,o){if(i){var n=1===o?1:3===o?-1:0,r=0===o?-1:2===o?1:0;i.hitCallback=function(a){"pass"===i.hitType&&(t.finish(),t.game.addIncident({incidentClass:e,key:"BattleFieldIncident@".concat(t.cellRow+r,"@").concat(t.cellCol+n),rowNum:Math.floor(32*Et.nextFloat()+16),colNum:Math.floor(32*Et.nextFloat()+16),playerStatus:{fromDoor:ne.getOppositeDoor(t.doors[o])}}),console.log("enter battlefield row: ".concat(t.cellRow+r,", col: ").concat(t.cellCol+n)))}}})}},{key:"handleNpcs",value:function(){var t=this;(this.incidentStatus.npcs||[]).forEach(function(e){var i=t.mapGroup.getSpriteByName(e.name);i.hitCallback=function(o){t.game.dialog||t.game.playConversation(n[e.name](i,o,t))}})}},{key:"handlePlayerMove",value:function(t,e){var i=this.game.keyMap.up,o=this.game.keyMap.down,n=this.game.keyMap.left,r=this.game.keyMap.right,a=(i.isDown||o.isDown)&&(n.isDown||r.isDown),l=t.vMax/Math.sqrt(2);i.isDown&&(t.vy=-(a?l:t.vMax)),o.isDown&&(t.vy=a?l:t.vMax),n.isDown&&(t.vx=-(a?l:t.vMax)),r.isDown&&(t.vx=a?l:t.vMax),i.isDown||o.isDown||(t.vy=0),n.isDown||r.isDown||(t.vx=0),t.move()}}])&&le(i.prototype,o),r&&le(i,r),e}();function fe(t){return(fe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function de(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function pe(t,e){return!e||"object"!==fe(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function ye(t){return(ye=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function ge(t,e){return(ge=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var ve=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),pe(this,ye(e).call(this,t))}var i,o,n;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&ge(t,e)}(e,ne),i=e,(o=[{key:"createMapData",value:function(){this.mapData=Zt({width:32,height:32,tileWidth:this.game.tileWidth,tileHeight:this.game.tileHeight,objects:[{x:(this.width-this.objectWidth.m)/2,y:(this.height-this.objectHeight.l)/4,width:this.objectWidth.m,height:this.objectHeight.l,name:"king"},{x:(this.width-this.objectWidth.m)/2,y:(this.height-this.objectHeight.l)/2,width:this.objectWidth.m,height:this.objectHeight.l,name:"player"}]})}},{key:"addSceneSprites",value:function(){this.castleDoorScene=this.addSceneBySpriteName("castleDoor","bottomDoorSprite"),this.castleDoorScene.backgroundColor=w.red[3],this.castleDoorScene.hitType="stop"}},{key:"setCamera",value:function(){var t=this.mapGroup.getSpriteByName("player");this.game.camera.follow(t,{})}},{key:"bindEventCallback",value:function(){var t=this,e=this.mapGroup.getSpriteByName("king");e.hitCallback=function(i){t.game.dialog||t.game.playConversation(function(t,e){return t.state.hasIntroduced?[{fromSpriteKey:"KingDialogSprite",content:"Please find the gem of fire first!",options:{color:w.red[3]}}]:(t.state.hasIntroduced=!0,[{content:"Hello warrior, welcome to the land of three gems!"},{content:"I am the real king. You know, I run this place."},{content:"However, that's until 5 years ago, when the dragons took our gems!"},{content:"The world is suffering in fear..."},{content:"Please bring back the gems and restore the world peace!"},{fromSpriteKey:"PlayerDialogSprite",content:"That sounds great! Kill the dragons and get the gems, that's what I do for a living!"},{content:"Well, the dragon king is too powerful for you at this moment, I am afraid."},{fromSpriteKey:"PlayerDialogSprite",content:"...Excuse me?"},{content:"No offense! I am sure you will be stronger with the gem of fire."},{content:"Please find the gem of fire first!",options:{color:w.red[3]}}].map(function(t){return t.fromSpriteKey||(t.fromSpriteKey="KingDialogSprite"),t}))}(e),function(){t.castleDoorScene.backgroundColor=w.green[3],t.castleDoorScene.hitType="pass"})},this.handleDoors()}},{key:"handleDoors",value:function(){var t=this;this.castleDoorScene.hitCallback=function(e){if("pass"===t.castleDoorScene.hitType){t.finish();var i=Math.floor(32*Et.nextFloat()+16),o=Math.floor(32*Et.nextFloat()+16),n=o*t.game.tileWidth,r=i*t.game.tileHeight;t.game.addIncident({incidentClass:ue,key:"BattleFieldIncident@".concat(t.game.maze.startRow,"@").concat(t.game.maze.startCol),rowNum:i,colNum:o,playerStatus:{fromDoor:"top"},incidentStatus:{npcs:[{name:"john",width:t.objectWidth.m,height:t.objectHeight.l,x:(n-t.objectWidth.m)/2,y:(r-t.objectHeight.l)/2}]}})}},this.castleDoorScene.backgroundColor=w.green[3],this.castleDoorScene.hitType="pass"}},{key:"update",value:function(t){var e=this.mapGroup.getSpriteByName("player");this.handlePlayerMove(e,t)}},{key:"handlePlayerMove",value:function(t,e){var i=this.game.keyMap.up,o=this.game.keyMap.down,n=this.game.keyMap.left,r=this.game.keyMap.right,a=(i.isDown||o.isDown)&&(n.isDown||r.isDown),l=t.vMax/Math.sqrt(2);i.isDown&&(t.vy=-(a?l:t.vMax)),o.isDown&&(t.vy=a?l:t.vMax),n.isDown&&(t.vx=-(a?l:t.vMax)),r.isDown&&(t.vx=a?l:t.vMax),i.isDown||o.isDown||(t.vy=0),n.isDown||r.isDown||(t.vx=0),t.move()}}])&&de(i.prototype,o),n&&de(i,n),e}();function me(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"0",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"0";return(parseInt(t,2)+parseInt(e,2)>>>0).toString(2)}var be=5,we=5,ke="top",Se="bottom";function xe(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:we,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:be,o=Ce(t,e,i),n=o.col,r=o.row,a=[];return a.push(Oe(n,r-1,e,i)),a.push(Oe(n+1,r,e,i)),a.push(Oe(n,r+1,e,i)),a.push(Oe(n-1,r,e,i)),a}function Oe(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:we,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:be;return t<0||t>=i||e<0||e>=o?-1:e*i+t}function Ce(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:we,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:be;return t<0||t>=e*i?null:{row:Math.floor(t/e),col:t%e}}var De=new Mt({container:document.getElementById("root"),tileWidth:20,tileHeight:20,cameraWidth:window.innerWidth,cameraHeight:window.innerHeight});De.loop.add(function(t){if(!De.flag.isLoadAssets)return De.loadSprites(),De.loadSounds(),De.flag.isLoadAssets=!0,!1;if(!De.flag.hasBuiltLayers)return De.addLayer("background"),De.addLayer("main"),De.addLayer("foreground"),De.flag.hasBuiltLayers=!0,!1;if(!De.flag.isPlayDirty){for(var e=!1,i=0;i<De.incidentPlays.length;i++){var o=De.incidentPlays[i];if(!(e="boolean"==typeof o?o:o(t)))break}return De.flag.isPlayDirty=e,!1}return!!De.flag.isGameOver&&void 0}),De.loop.start(),De.addInteractionKey("up",Mt.createKeyInteraction([87,38])),De.addInteractionKey("down",Mt.createKeyInteraction([83,40])),De.addInteractionKey("left",Mt.createKeyInteraction([65,37])),De.addInteractionKey("right",Mt.createKeyInteraction([68,39])),De.addInteractionKey("enter",Mt.createKeyInteraction([13])),De.addInteractionKey("space",Mt.createKeyInteraction([32])),De.maze=function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.rowNum,i=void 0===e?be:e,o=t.colNum,n=void 0===o?we:o,r=t.startSide,a=void 0===r?ke:r,l=t.endSide,s=void 0===l?Se:l,h=[],c=0;c<i;c++){var u=[];h.push(u);for(var f=0;f<n;f++)u.push("")}var d,p,y,g,v=[];switch(a){case"top":p=0,d=Math.floor(Et.nextFloat()*n),h[p][d]="1000";break;case"bottom":p=i-1,d=Math.floor(Et.nextFloat()*n),h[p][d]="0010";break;case"left":p=Math.floor(Et.nextFloat()*i),d=0,h[p][d]="0001";break;case"right":p=Math.floor(Et.nextFloat()*i),d=n-1,h[p][d]="0100";break;default:throw new Error("invalid start side: ".concat(a))}var m=Oe(d,p,n,i);xe(m,n,i).forEach(function(t){-1!==t&&v.push("".concat(m,"-").concat(t))});for(var b=function(){var t=v.splice(Math.floor(Et.nextFloat()*v.length),1)[0],e=parseInt(t.split("-")[0]),o=parseInt(t.split("-")[1]);(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[[],[]],o=i.length,n=i[0].length;if(-1===xe(t,n,o).indexOf(e))return!1;var r=Ce(t,n,o),a=r.col,l=r.row,s=Ce(e,n,o),h=s.col,c=s.row;return(!i[l][a]||!i[c][h])&&(a+1===h&&l===c?(i[l][a]=me(i[l][a]||"0","0100"),i[c][h]=me(i[c][h]||"0","0001")):h+1===a&&l===c?(i[l][a]=me(i[l][a]||"0","0001"),i[c][h]=me(i[c][h]||"0","0100")):c+1===l&&h===a?(i[l][a]=me(i[l][a]||"0","1000"),i[c][h]=me(i[c][h]||"0","0010")):l+1===c&&h===a&&(i[l][a]=me(i[l][a]||"0","0010"),i[c][h]=me(i[c][h]||"0","1000")),!0)})(e,o,h)&&xe(o,n,i).forEach(function(t){if(-1!==t&&t!==e){var i="".concat(o,"-").concat(t),n="".concat(t,"-").concat(o);-1===v.indexOf(i)&&-1===v.indexOf(n)&&v.push(i)}})};v.length;)b();switch(s){case"top":g=0,y=Math.floor(Et.nextFloat()*n),h[g][y]=me(h[g][y],"1000");break;case"bottom":g=i-1,y=Math.floor(Et.nextFloat()*n),h[g][y]=me(h[g][y],"0010");break;case"left":g=Math.floor(Et.nextFloat()*i),y=0,h[g][y]=me(h[g][y],"0001");break;case"right":g=Math.floor(Et.nextFloat()*i),y=n-1,h[g][y]=me(h[g][y],"0100");break;default:throw new Error("invalid end side: ".concat(s))}return{rowNum:i,colNum:n,cells:h,startRow:p,startCol:d,endRow:g,endCol:y}}({rowNum:8,colNum:8,startSide:"top",endSide:"bottom"}),De.addIncident({incidentClass:ve,key:"BattleFieldIncident@".concat(De.maze.startRow-1,"@").concat(De.maze.startCol)})}]);